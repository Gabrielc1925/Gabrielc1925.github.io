<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Packer Backup | Gabriel J. Chavez </title> <meta name="author" content="Gabriel J. Chavez"> <meta name="description" content="Automate AMI Creation"> <meta name="keywords" content="DevOps, CI/CD, Terraform, Kubernetes, AWS, Cloud, Automation"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?85d53cdc642525c2ea19006b5b11cfd1"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://gabrielc1925.github.io/projects/packer_aws_backup/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Gabriel J. Chavez </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Packer Backup</h1> <p class="post-description">Automate AMI Creation</p> </header> <article> <p>First on my list of things to do after getting this website up and running is to build up my portfolio of projects. I will be using the Hashicorp suite of products as they are widely used and a good base level of knowledge for anyone who wishes to branch out into other platforms.</p> <p>This first step in the process is to use Packer to create an Amazon Machine Image for use on AWS. This is a very small part of the overall CI/CD workflow, but I am going to do it in steps so that I can explain each file in depth.</p> <p>The files for this project can be found in the Github repo for this website: <a href="https://github.com/Gabrielc1925/Gabrielc1925.github.io" rel="external nofollow noopener" target="_blank">github.com/gabrielc1925/gabrielc1925.github.io</a>.</p> <p>The files use in this basic Packer deployment are: “/build.pkr.hcl” “/setup-deps-gh-pages.sh” “/.github/workflows/build-deploy-packer-aws.yml” “/.github/scripts/create_channel_version.sh”</p> <p>This workflow is triggered by the “build-deploy-packer-aws.yml” file.</p> <p>The first block establishes the timing for when to run this github action. I set it to only run when a change was pushed to the gh-pages branch, as that is the final step after all other checks when a pull request is completed. I don’t want to update my AMI unnecessarily, so I put this github action to run after all other actions are done.</p> <p>```yml file=build-deploy-packer-aws.yml name: Deploy to Packer and AWS</p> <p>on: push: tags: [“v[0-9].[0-9]+.[0-9]+”] branches: - “gh-pages”</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
The environment variables and where to find them are then defined, and then the jobs block begins.
The first job copies the repo with checkout and links it in an environment variable so that it can be accessed by later parts of the gh-actions scripts. It then links the AWS credentials stored in the gh secrets manager to local env variables for this set of functions.

```yml file=build-deploy-packer-aws.yml
jobs:
  build-artifact:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      version_fingerprint: $
    steps:
      - name: Checkout Repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@8c3f20df09ac63af7b3ae3d7c91f105f857d8497 # v4.0.0
        with:
          aws-access-key-id: $
          aws-secret-access-key: $
          aws-region: us-east-1
</code></pre></div></div> <p>The gh-actions script then begins to run Packer. It initializes the plugins required, then either runs a normal packer build command or includes a tag when running packer build to keep track of major deployments. Finally, it records the Packer version fingerprint for use by later scripts and applications.</p> <p>```yml file=build-deploy-packer-aws.yml - name: Packer Init run: packer init .</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Packer Build - Branches
    if: startsWith(github.ref, 'refs/heads/')
    run: packer build .

- name: Packer Build - Tags
    if: startsWith(github.ref, 'refs/tags/v')
    run: HCP_PACKER_BUILD_FINGERPRINT=$(date +'%m%d%YT%H%M%S') packer build .

- name: Get HCP Packer version fingerprint from Packer Manifest
    id: hcp
    run: |
        last_run_uuid=$(jq -r '.last_run_uuid' "./packer_manifest.json")
        build=$(jq -r '.builds[] | select(.packer_run_uuid == "'"$last_run_uuid"'")' "./packer_manifest.json")
        version_fingerprint=$(echo "$build" | jq -r '.custom_data.version_fingerprint')
        echo "::set-output name=version_fingerprint::$version_fingerprint" ```
</code></pre></div></div> <p>Packer build begins by reading the build.pkr.hcl file and loading the plugins listed. It then lists the source for the AMI we will be building and provisioning. I went with a lightweight and low cost Ubuntu LTS 22.04 image as I do not need more than that for this project.</p> <p>```hcl file=build.pkr.hcl packer { required_plugins { amazon = { source = “github.com/hashicorp/amazon” version = “~&gt; 1.3.2” } } }</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>source "amazon-ebs" "github-pages" {
region = "us-east-1"
source_ami    = "ami-04a81a99f5ec58529"
instance_type  = "t2.micro"
ssh_username   = "ubuntu"
ami_name    = "Gabrielc1925-github-io_"
ami_regions = ["us-east-1"]
} ```
</code></pre></div></div> <p>The next step is to begin our build block. The first step is to connect to the HCP packer registry and create a bucket to track our changes and store any completed AMIs in later steps.</p> <p>```hcl file=build.pkr.hcl build { # HCP Packer settings hcp_packer_registry { bucket_name = “Gabrielc1925-github-io” description = «EOT This is an image for a backup of the github pages site for gabrielc1925 EOT</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    bucket_labels = {
    "hashicorp-learn" = "learn-packer-github-actions",
    }
} ```
</code></pre></div></div> <p>After that the build block specifies the source it is acting on (we only have one above, so this is it), and begins to provision the base image for us. It then runs a provisioner block when the EC2 instance is running, and inputs the commands from the shell scripts specified by the file named “setup-deps-gh-pages.sh.”</p> <p>(After that there is a post processer function that prints the outputs to a file, lists the paths from the volume root for each, and tags the file with the fingerprint from this particular version. This part is not terribly important for our current setup, but can be used later with Terraform to track changed assets. I won’t talk more about those 5 lines of code in this article.)</p> <p>```hcl file=build.pkr.hcl sources = [ “source.amazon-ebs.github-pages”, ]</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Set up Nginx with HTML files from github pages
provisioner "shell" {
    scripts = [
    "setup-deps-gh-pages.sh"
    ]
}

post-processor "manifest" {
    output     = "packer_manifest.json"
    strip_path = true
    custom_data = {
    version_fingerprint = packer.versionFingerprint
    }
} ```
</code></pre></div></div> <p>When the provisioner shell triggers the scripts listed in setup-deps-gh-pages.sh, the commands are input into the EC2 instance via SSH. The first few blocks establish procedures for handling response to errors, then download and install Docker and Nginx. Docker is not used for this step of the project, I just added it out of habit. Nginx is then set to start automatically on boot.</p> <p>```sh file=setup-deps-gh-pages.sh #!/bin/bash set -eu -o pipefail</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to apt-get sources:
echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
$(. /etc/os-release &amp;&amp; echo "$VERSION_CODENAME") stable" | \
sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt-get update

# Install necessary dependencies
sudo apt-get update
sudo apt-get install -y git-all nginx docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Configure Nginx to start on boot using systemd
sudo systemctl enable nginx
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
The next few blocks download the github repo, change to the main branch, and copy the nginx configuration files into the appropriate directories. The prebuilt html files that were output by jekyll for this site are then copied from the gh-pages branch into the appropriate location for nginx to use them. Finally, nginx is reloaded to enact the changes.

```sh file=setup-deps-gh-pages.sh
    # Get github pages files
    cd ~
    git clone https://github.com/Gabrielc1925/Gabrielc1925.github.io.git
    cd Gabrielc1925.github.io
    git checkout main

    # Set up nginx configuration
    cd nginx_setup
    cp  -r -f conf.d /etc/nginx
    cp -f nginx.conf /etc/nginx

    # Set up nginx site html pages
    mkdir /var/www/gabrielc1925.github.io
    cd ~/Gabrielc1925.github.io
    git checkout gh-pages
    cp ~/Gabrielc1925.github.io/{_pages/dropdown,assets,blog,cv,news,projects,repositories,workflow,404.html,feed.xml,index.html,robots.txt,sitemap.xml} /var/www/gabrielc1925.github.io

    # Reload nginx
    nginx -s reload
</code></pre></div></div> <p>At this point Packer is complete and has created a working AMI on my AWS account. It has not saved this AMI to a registry or set up long-term management with Terraform, but the script worked so it is the first step of a CI/CD workflow.</p> <p>The gh-actions workflow has one more job to run still, so it triggers the function to update the HCP Packer registry with the work we did.</p> <p>’'’yml file=build-deploy-packer-aws.yml update-hcp-packer-channel: name: Update HCP Packer channel needs: [“build-artifact”] runs-on: ubuntu-latest steps: - name: Checkout Repository uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    - name: Create and set channel
        working-directory: .github/scripts
        run: |
        channel_name=$( echo $ | sed 's/\./-/g')
        ./create_channel_version.sh $HCP_BUCKET_NAME $channel_name "$"
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

This triggers the helper script based in "create_channel_version.sh," which records the changes to the Packer registry in the bucket we specified.  This section is not something that I wrote, I just copied it from Hashicorp's example repo and ensured no modifications were needed due to my region or bucket name.
The script uses a bunch of metadata to ensure that the files generated have unique names so they will work with HCP registry


```sh file=create_channel_version.sh
    #! /usr/bin/env bash

    set -eEuo pipefail

    usage() {
    cat &lt;&lt;EOF
    This script is a helper for setting a channel version in HCP Packer
    Usage:
    $(basename "$0") &lt;bucket_slug&gt; &lt;channel_name&gt; &lt;version_fingerprint&gt;
    ---
    Requires the following environment variables to be set:
    - HCP_CLIENT_ID
    - HCP_CLIENT_SECRET
    - HCP_ORGANIZATION_ID
    - HCP_PROJECT_ID
    EOF
    exit 1
    }

    # Entry point
    test "$#" -eq 3 || usage

    bucket_slug="$1"
    channel_name="$2"
    version_fingerprint="$3"
    auth_url="${HCP_AUTH_URL:-https://auth.hashicorp.com}"
    api_host="${HCP_API_HOST:-https://api.cloud.hashicorp.com}"
    base_url="$api_host/packer/2023-01-01/organizations/$HCP_ORGANIZATION_ID/projects/$HCP_PROJECT_ID"

    # If on main branch, set channel to release
    if [ "$channel_name" == "main" ]; then
    channel_name="release"
    fi

    echo "Attempting to assign version ${version_fingerprint} in bucket ${bucket_slug} to channel ${channel_name}"

    # Authenticate
    response=$(curl --request POST --silent \
    --url "$auth_url/oauth/token" \
    --data grant_type=client_credentials \
    --data client_id="$HCP_CLIENT_ID" \
    --data client_secret="$HCP_CLIENT_SECRET" \
    --data audience="https://api.hashicorp.cloud")
    api_error=$(echo "$response" | jq -r '.error')
    if [ "$api_error" != null ]; then
    echo "Failed to get access token: $api_error"
    exit 1
    fi
    bearer=$(echo "$response" | jq -r '.access_token')

    # Get or create channel
    echo "Getting channel ${channel_name}"
    response=$(curl --request GET --silent \
    --url "$base_url/buckets/$bucket_slug/channels/$channel_name" \
    --header "authorization: Bearer $bearer")
    api_error=$(echo "$response" | jq -r '.message')
    if [ "$api_error" != null ]; then
    echo "Channel ${channel_name} like doesn't exist, creating new channel"
    # Channel likely doesn't exist, create it
    api_error=$(curl --request POST --silent \
        --url "$base_url/buckets/$bucket_slug/channels" \
        --data-raw '{"name":"'"$channel_name"'"}' \
        --header "authorization: Bearer $bearer" | jq -r '.error')
    if [ "$api_error" != null ]; then
        echo "Error creating channel: $api_error"
        exit 1
    fi
    fi

    # Update channel to point to version
    echo "Updating channel ${channel_name} to version fingerprint ${version_fingerprint}"
    api_error=$(curl --request PATCH --silent \
    --url "$base_url/buckets/$bucket_slug/channels/$channel_name" \
    --data-raw '{"version_fingerprint": "'$version_fingerprint'", "update_mask": "versionFingerprint"}' \
    --header "authorization: Bearer $bearer" | jq -r '.message')
    if [ "$api_error" != null ]; then
        echo "Error updating channel: $api_error"
        exit 1
    fi
</code></pre></div></div> <p>After that, the gh-actions workflow is completed and the AMI generated by Packer is terminated.</p> <p>The next steps are to set up terraform for this site, and to confure a system to fail over to AWS in case of an outage.</p> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Gabriel J. Chavez. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. <a href="https://www.flaticon.com/free-icons/programmer" title="programmer icons" rel="external nofollow noopener" target="_blank">Programmer icons created by Flat Icons - Flaticon</a> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>