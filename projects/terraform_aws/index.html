<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Terraform Deployment to Aws | Gabriel J. Chavez </title> <meta name="author" content="Gabriel J. Chavez"> <meta name="description" content="Deploy to AWS from Packer AMI"> <meta name="keywords" content="DevOps, CI/CD, Terraform, Kubernetes, AWS, Cloud, Automation"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico?85d53cdc642525c2ea19006b5b11cfd1"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://gabrielc1925.github.io/projects/terraform_aws/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Gabriel J. Chavez </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/projects/">projects</a> <div class="dropdown-divider"></div> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Terraform Deployment to Aws</h1> <p class="post-description">Deploy to AWS from Packer AMI</p> </header> <article> <p>The next thing to do is to use Terraform to create resources in AWS from my Packer image. Terraform can use separate files to host data and variables, but I decided to keep it all in one file since this is a small project and that will help to simplify things.</p> <p>I begun by maing a main.tf file to hold my Terraform configuration. The first block defines the provider plugins that are needed. For this project, I will be using the cloud platform for HCP, as that is where I stored my Packer files. I also will be using AWS, since that is where I will be deploying the image to.</p> <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">terraform</span> <span class="p">{</span>
    <span class="nx">cloud</span> <span class="p">{</span>
        <span class="nx">organization</span> <span class="o">=</span> <span class="s2">"Gabrielc1925-github-io"</span>
        <span class="nx">workspaces</span> <span class="p">{</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="s2">"Gabrielc1925-github-io"</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">required_providers</span> <span class="p">{</span>
        <span class="nx">hcp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">source</span> <span class="o">=</span> <span class="s2">"hashicorp/hcp"</span>
            <span class="nx">version</span> <span class="o">=</span> <span class="s2">"~&gt;0.94.1"</span>
        <span class="p">}</span>
        <span class="nx">aws</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">source</span>  <span class="o">=</span>   <span class="s2">"hashicorp/aws"</span>
            <span class="nx">version</span>     <span class="o">=</span>   <span class="s2">"~&gt;5.0"</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The next block defines the hcp provider, and is where I configure it. My terminal was missing a dependency to send out the authentication request to hcp in the normal way, so I could not get the script to run right away. I tried a number of different authentication methods described in the terraform documentation, including environment variables and credential files, but finally I decided to just move on with the rest of the terraform configuration and I just hard coded the arguments for client_id and client_secret. Obviously I am not going to include those below, but I will put a commented out placeholder for clarity’s sake. (the project_id and credential_file were from other attempts at authentication. I am leaving them for now so that when I go back to fix authentication I can save some time. No risk to having them exposed.)</p> <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">provider</span> <span class="s2">"hcp"</span> <span class="p">{</span>
<span class="c1">#    client_id = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span>
<span class="c1">#    client_secret = "xxxxxxxxxxxxxxxxxxXXX"</span>
<span class="c1">#    project_id = "b1bbb80d-e6cd-49c6-b855-bec80721fb28"</span>
<span class="c1">#    credential_file = "/home/gabrielc1925/.terraform.d/credentials.tfrc.json"</span>
<span class="p">}</span>
</code></pre></div></div> <p>After that, I began to describe the resources that hcp would use. This is mainly defining a bucket for it to put information into, and to tell it where the ami created by Packer is located.</p> <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">resource</span> <span class="s2">"hcp_packer_bucket"</span> <span class="s2">"Gabrielc1925-github-io"</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"Gabrielc1925-githb-io"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"hcp_packer_channel"</span> <span class="s2">"latest"</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="s2">"latest"</span>
    <span class="nx">bucket_name</span> <span class="o">=</span> <span class="s2">"Gabrielc1925-github-io"</span>
<span class="p">}</span>

<span class="c1"># Create local variable and get artifact ID from the base artifact</span>
<span class="k">data</span> <span class="s2">"hcp_packer_version"</span> <span class="s2">"ResumeWebsiteBackup_AWS"</span> <span class="p">{</span>
    <span class="nx">bucket_name</span> <span class="o">=</span> <span class="s2">"Gabrielc1925-github-io"</span>
    <span class="nx">channel_name</span>    <span class="o">=</span> <span class="s2">"latest"</span>
<span class="p">}</span>

<span class="k">data</span> <span class="s2">"hcp_packer_artifact"</span> <span class="s2">"Gabrielc1925-github-io"</span> <span class="p">{</span>
  <span class="nx">bucket_name</span>   <span class="o">=</span> <span class="s2">"Gabrielc1925-github-io"</span>
  <span class="nx">version_fingerprint</span> <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="nx">hcp_packer_version</span><span class="p">.</span><span class="nx">ResumeWebsiteBackup_AWS</span><span class="p">.</span><span class="nx">fingerprint</span>
  <span class="nx">platform</span>      <span class="o">=</span> <span class="s2">"aws"</span>
  <span class="nx">region</span>        <span class="o">=</span> <span class="s2">"us-east-1"</span>
<span class="p">}</span>
</code></pre></div></div> <p>This information was found in my HCP Packer registry.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/Packer_ami-480.webp 480w,/assets/img/Packer_ami-800.webp 800w,/assets/img/Packer_ami-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/Packer_ami.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="HCP Packer Registry" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Organization name removed for security.</p> <p>Now that terraform knows where to find the ami created by Packer, it is time to begin configuring aws to prepare it to accept connections from terraform. Again, I had extended problems figuring out how to configure authentication to AWS that would play nicely with the rest of my terraform plan. The commented out code here is reflective of that.<br> I ended up realizing that the best way to solve this was to provide environment variables to hcp in the Terraform HCP online portal. These environment variables allowed me to not have to hard code them into my terraform file or store environment variables locally. They are not referenced here, as hcp obtains them automatically when the terraform file is applied.</p> <div class="language-tf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
    <span class="nx">region</span>  <span class="o">=</span>   <span class="s2">"us-east-1"</span>
    <span class="c1"># profile = "default"</span>
    <span class="c1"># # The following two are used for local testing</span>
    <span class="c1"># shared_config_files = ["/home/gabrielc1925/.aws/config"]</span>
    <span class="c1"># shared_credentials_files = ["/home/gabrielc1925/.aws/credentials"]</span>
    <span class="c1"># The following two are for using with github actions saved credential secrets</span>
    <span class="c1"># access_key = AWS ACCESS_KEY_ID</span>
    <span class="c1"># secret_key = AWS_SECRET_ACCESS_KEY</span>
<span class="p">}</span>
</code></pre></div></div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Gabriel J. Chavez. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. <a href="https://www.flaticon.com/free-icons/programmer" title="programmer icons" rel="external nofollow noopener" target="_blank">Programmer icons created by Flat Icons - Flaticon</a> </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>